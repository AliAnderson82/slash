<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slash</title>
  <link rel="icon" type="image/x-icon" href="./favicon.ico">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="container">
    <header>Slash</header>

    <div class="input-area">
      <textarea id="postInput" placeholder="What's happening?"></textarea>
      <input type="file" id="imageInput" accept="image/*" />
      <button onclick="postMessage()">Post</button>
    </div>

    <ul id="feed" class="feed"></ul>
  </div>

  <button id="accountBtn" onclick="openAccountModal()" style="display:none;">
    <img id="accountPfp" src="" alt="pfp">
  </button>

  <div id="accountModal">
    <div class="modal-content">
      <p><strong id="accountUsername"></strong></p>
      <input type="file" id="pfpInput" accept="image/*" />
      <button onclick="uploadPfp()">Change Profile Picture</button>
      <hr>
      <input type="password" id="oldPassword" placeholder="Old Password" />
      <input type="password" id="newPassword" placeholder="New Password" />
      <button onclick="changePassword()">Change Password</button>
      <hr>
      <button onclick="closeAccountModal()">Close</button>
    </div>
  </div>

  <div id="authModal">
    <div class="modal-content">
      <input type="text" id="loginUsername" placeholder="Username (admin only)" />
      <div class="group">
        <svg stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="icon">
          <path d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" stroke-linejoin="round" stroke-linecap="round"></path>
        </svg>
      <input class="input" type="password" placeholder="password">
      </div>
      <button onclick="login()">Login</button>
      <hr>
      <input type="password" id="signupPassword" placeholder="New Password" />
      <button onclick="signup()">Signup</button>
    </div>
  </div>

  <script>
    const apiUrl = `${window.location.protocol}//slash.serveo.net/api/messages`;
    const userInfoUrl = `${window.location.protocol}//slash.serveo.net/api/user`;

    document.addEventListener("DOMContentLoaded", () => {
      loadPosts();
      loadUser();
      setInterval(loadPosts, 1000);
    });

    function loadPosts() {
      fetch(apiUrl)
        .then(response => response.json())
        .then(posts => {
          posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          const feed = document.getElementById("feed");
          feed.innerHTML = "";
          posts.forEach(post => {
            addPostToFeed(post, false);
          });
        })
        .catch(error => console.error("Error loading posts:", error));
    }

    function postMessage() {
      const input = document.getElementById("postInput");
      const imageInput = document.getElementById("imageInput");
      const message = input.value.trim();

      const formData = new FormData();
      formData.append("message", message);
      if (imageInput.files.length > 0) {
        formData.append("image", imageInput.files[0]);
      }

      if (message || imageInput.files.length > 0) {
        fetch(apiUrl, {
          method: "POST",
          body: formData
        })
          .then(response => response.json())
          .then(savedPost => {
            addPostToFeed(savedPost, true);
            input.value = "";
            imageInput.value = null;
          })
          .catch(error => console.error("Error posting message:", error));
      }
    }

    function addPostToFeed(post, toTop = true) {
      const feed = document.getElementById("feed");

      const postElement = document.createElement("li");
      postElement.classList.add("post");

      let content = `
        <div class="username-row">
          ${post.pfp ? `<img src="${post.pfp}" class="pfp" alt="pfp" />` : ""}
          <span class="username">${post.username}</span>
        </div>
        <div class="message">${post.message}</div>
        <div class="timestamp">${new Date(post.timestamp).toLocaleString()}</div>
      `;

      if (post.imageUrl) {
        content += `<img src="${post.imageUrl}" alt="Uploaded image">`;
      }

      postElement.innerHTML = content;
      if (toTop) {
        feed.insertBefore(postElement, feed.firstChild);
      } else {
        feed.appendChild(postElement);
      }
    }

    function toggleAccountModal() {
      const modal = document.getElementById("accountModal");
      modal.style.display = modal.style.display === "none" ? "block" : "none";
    }

    function loadUser() {
      fetch(userInfoUrl)
        .then(res => res.json())
        .then(data => {
          document.getElementById("accountUsername").textContent = data.username;
          if (data.pfp) {
            document.getElementById("accountPfp").src = data.pfp;
          }
        })
        .catch(err => console.error("Not logged in", err));
    }

    document.getElementById("passwordForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const newPassword = document.getElementById("newPassword").value;
      fetch("/api/change-password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: newPassword })
      }).then(() => alert("Password changed"));
    });

    document.getElementById("pfpForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const formData = new FormData();
      const file = document.getElementById("newPfp").files[0];
      formData.append("pfp", file);

      fetch("/api/upload-pfp", {
        method: "POST",
        body: formData
      })
        .then(() => {
          alert("Profile picture updated");
          loadUser();
        });
    });

    function logout() {
      fetch("/logout", { method: "POST" })
        .then(() => {
          window.location.reload();
        });
    }
  </script>
</body>
</html>
